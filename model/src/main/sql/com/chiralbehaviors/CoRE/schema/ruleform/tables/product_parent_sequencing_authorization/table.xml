<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd"
>

    <changeSet author="hhildebrand" id="1390879803225-43">
        <createTable remarks="Determines what the next available product should be, based on the status code returned for the previous product"
            tableName="ruleform.product_parent_sequencing_authorization"
        >
            <column autoIncrement="true" name="id" remarks="Unique identifier" type="BIGSERIAL">
                <constraints primaryKey="true" primaryKeyName="product_parent_sequencing_authorization_pkey" />
            </column>
            <column name="service" remarks="The last product of a given protocol that was completed" type="INT8">
                <constraints nullable="false" />
            </column>
            <column name="status_code" remarks="The status of the last product completed" type="INT8">
                <constraints nullable="false" />
            </column>
            <column defaultValueComputed="1" name="sequence_number"
                remarks="Ordering and uniqueness, for when a product / Status Code combination can trigger multiple child products" type="ruleform.sequence_number"
            >
                <constraints nullable="false" />
            </column>
            <column name="parent"
                remarks="If this is the current job's parent's product, then we should set the parent job's status.  If this is NULL, then it can apply to any parent job that has an product equal to the current job's"
                type="INT8" />
            <column name="parent_status_to_set" remarks="The status to set for the parent job, provided it has an product equal to &quot;my_parent&quot;"
                type="INT8" />
            <column name="set_if_active_siblings"
                remarks="Determines if we set the parent job to the status denoted by &quot;parent_status_to_set&quot; if the current job has active sibling jobs.  Setting it to TRUE essentially overrides any say those sibling jobs might have."
                type="SMALLINT" />
            <column name="notes" remarks="Additional notes regarding usage of this particular rule" type="VARCHAR(10485760)" />
            <column name="updated_by" remarks="The agency that last updated this rule" type="INT8">
                <constraints nullable="false" />
            </column>
            <column defaultValueComputed="('now'::text)::timestamp(6) with time zone" name="update_date" remarks="The date this rule was last changed"
                type="TIMESTAMPTZ"
            >
                <constraints nullable="false" />
            </column>
        </createTable>
        <rollback>
            <dropTable tableName="ruleform.product_parent_sequencing_authorization" />
        </rollback>
    </changeSet>
    <changeSet author="hhildebrand" id="1390879803225-262">
        <addForeignKeyConstraint baseColumnNames="parent" baseTableName="ruleform.product_parent_sequencing_authorization"
            constraintName="product_parent_sequencing_authorization_my_parent_fkey" deferrable="true" initiallyDeferred="false" onDelete="RESTRICT"
            onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="ruleform.product" />
    </changeSet>
    <changeSet author="hhildebrand" id="1390879803225-263">
        <addForeignKeyConstraint baseColumnNames="service" baseTableName="ruleform.product_parent_sequencing_authorization"
            constraintName="product_parent_sequencing_authorization_parent_fkey" deferrable="true" initiallyDeferred="false" onDelete="RESTRICT"
            onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="ruleform.product" />
    </changeSet>
    <changeSet author="hhildebrand" id="1390879803225-264">
        <addForeignKeyConstraint baseColumnNames="parent_status_to_set" baseTableName="ruleform.product_parent_sequencing_authorization"
            constraintName="product_parent_sequencing_authorization_parent_status_to_set_fk" deferrable="true" initiallyDeferred="false"
            onDelete="RESTRICT" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="ruleform.status_code" />
    </changeSet>
    <changeSet author="hhildebrand" id="1390879803225-265">
        <addForeignKeyConstraint baseColumnNames="status_code" baseTableName="ruleform.product_parent_sequencing_authorization"
            constraintName="product_parent_sequencing_authorization_status_code_fkey" deferrable="true" initiallyDeferred="false" onDelete="RESTRICT"
            onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="ruleform.status_code" />
    </changeSet>
    <changeSet author="hhildebrand" id="1390879803225-266">
        <addForeignKeyConstraint baseColumnNames="updated_by" baseTableName="ruleform.product_parent_sequencing_authorization"
            constraintName="product_parent_sequencing_authorization_updated_by_fkey" deferrable="true" initiallyDeferred="false" onDelete="RESTRICT"
            onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="ruleform.agency" />
    </changeSet>
    <changeSet author="hhildebrand" id="1390879803225-403">
        <addUniqueConstraint columnNames="service, status_code, sequence_number" constraintName="product_parent_sequencing_authorization_parent_status_code_sequ"
            deferrable="false" disabled="false" initiallyDeferred="false" tableName="ruleform.product_parent_sequencing_authorization" />
    </changeSet>
    <changeSet author="hhildebrand" id="1390879803225-507">
        <createIndex indexName="product_parent_sequencing_authorization_updated_by_fkey_idx" tableName="ruleform.product_parent_sequencing_authorization"
            unique="false"
        >
            <column name="updated_by" />
        </createIndex>
    </changeSet>
</databaseChangeLog>
