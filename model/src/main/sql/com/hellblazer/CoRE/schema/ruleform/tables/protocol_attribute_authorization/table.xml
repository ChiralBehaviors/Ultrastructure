<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="1" author="hhildebrand">
        <sql><![CDATA[
            CREATE TABLE ruleform.protocol_attribute_authorization
            (
              id bigserial NOT NULL, -- Unique identifier
              requester bigint NOT NULL, 
              requester_classification bigint NOT NULL,
              deliver_from bigint NOT NULL, 
              deliver_from_classification bigint NOT NULL,
              deliver_to bigint NOT NULL, 
              deliver_to_classification bigint NOT NULL,
              product bigint NOT NULL, 
              product_classification bigint NOT NULL,
              service bigint NOT NULL, 
              service_classification bigint NOT NULL, 
              authorized_attribute bigint NOT NULL, 
              sequence_number ruleform.sequence_number NOT NULL DEFAULT 1, 
              grouping_resource bigint, 
              text_value character varying,
              integer_value integer,
              numeric_value numeric, 
              timestamp_value timestamp with time zone,
              notes character varying,
              research bigint,
              updated_by bigint NOT NULL, 
              update_date timestamp with time zone NOT NULL DEFAULT ('now'::text)::timestamp(6) with time zone,
              CONSTRAINT protocol_attribute_authorization_pkey PRIMARY KEY (id ),
              CONSTRAINT protocol_attribute_authorization_authorized_attribute_fkey FOREIGN KEY (authorized_attribute)
                  REFERENCES ruleform.attribute (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_requester_fkey FOREIGN KEY (requester)
                  REFERENCES ruleform.resource (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_requester_classification_fkey FOREIGN KEY (requester_classification)
                  REFERENCES ruleform.relationship (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_deliver_from_fkey FOREIGN KEY (deliver_from)
                  REFERENCES ruleform.location (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_deliver_from_classification_fkey FOREIGN KEY (deliver_from_classification)
                  REFERENCES ruleform.relationship (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_deliver_to_fkey FOREIGN KEY (deliver_to)
                  REFERENCES ruleform.product (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_deliver_to_classification_fkey FOREIGN KEY (deliver_to_classification)
                  REFERENCES ruleform.relationship (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_product_fkey FOREIGN KEY (product)
                  REFERENCES ruleform.product (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_product_classification_fkey FOREIGN KEY (product_classification)
                  REFERENCES ruleform.relationship (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_service_fkey FOREIGN KEY (service)
                  REFERENCES ruleform.product (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_service_classification_fkey FOREIGN KEY (service_classification)
                  REFERENCES ruleform.relationship (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_grouping_resource_fkey FOREIGN KEY (grouping_resource)
                  REFERENCES ruleform.resource (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_research_fkey FOREIGN KEY (research)
                  REFERENCES ruleform.research (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_authorization_updated_by_fkey FOREIGN KEY (updated_by)
                  REFERENCES ruleform.resource (id) MATCH SIMPLE
                  ON UPDATE CASCADE ON DELETE RESTRICT,
              CONSTRAINT protocol_attribute_auth_classification_attri_key UNIQUE (grouping_resource, requester, requester_classification, deliver_from, deliver_from_classification, deliver_to, deliver_to_classification, service, service_classification, product, product_classification, authorized_attribute , sequence_number )
            )
            WITH (
              OIDS=FALSE
            );
            COMMENT ON TABLE ruleform.protocol_attribute_authorization
              IS 'Defines rules stating what attributes (and values thereof) are authorized for particular Protocols';
            ]]>
        </sql>
        <rollback>
            <dropTable tableName="ruleform.protocol_attribute_authorization" />
        </rollback>
    </changeSet>
</databaseChangeLog>
