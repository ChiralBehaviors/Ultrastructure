<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="1" author="hhildebrand">
        <sql><![CDATA[
	        CREATE OR REPLACE VIEW readable.meta_protocol AS 
	             SELECT base_table.id, s.name AS service, base_table.sequence_number, 
	                    rr.name AS requesting_resource, st.name AS service_type, 
	                    po.name AS product_ordered, dt.name AS deliver_to, 
	                    df.name AS deliver_from, base_table.stop_on_match,
	                    base_table.notes, res.name AS research, 
	                    up.name AS updated_by, base_table.update_date
				   FROM ruleform.meta_protocol base_table
				   JOIN ruleform.product s ON base_table.service = s.id
                   LEFT JOIN ruleform.relationship rr ON base_table.requesting_resource = rr.id
				   LEFT JOIN ruleform.relationship st ON base_table.service_type = st.id
				   LEFT JOIN ruleform.relationship po ON base_table.product_ordered = po.id
                   LEFT JOIN ruleform.relationship dt ON base_table.deliver_to= dt.id
                   LEFT JOIN ruleform.relationship df ON base_table.deliver_from = df.id
				   LEFT JOIN ruleform.research res ON base_table.research = res.id
				   JOIN ruleform.resource up ON base_table.updated_by = up.id;
				
				ALTER TABLE readable.meta_protocol
				  OWNER TO core;
				GRANT ALL ON TABLE readable.meta_protocol TO core;
				GRANT SELECT ON TABLE readable.meta_protocol TO core_read_write;
				GRANT SELECT ON TABLE readable.meta_protocol TO core_read_only;
            ]]>
        </sql>
        <rollback>
            <dropView viewName="readable.meta_protocol" />
        </rollback>
    </changeSet>
</databaseChangeLog>
