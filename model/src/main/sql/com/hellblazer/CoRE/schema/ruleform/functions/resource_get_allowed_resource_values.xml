<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    
    <changeSet id="1" author="hhildebrand">
        <sql splitStatements="false"><![CDATA[
            CREATE OR REPLACE FUNCTION ruleform.resource_get_allowed_resource_values(p_classification_attribute bigint, p_classifier bigint, p_attribute bigint)
              RETURNS SETOF ruleform.resource AS
            $BODY$
            DECLARE
                _type TEXT;
                _auth ruleform.resource_attribute_authorization%ROWTYPE;
            BEGIN
                SELECT ruleform.get_attribute_type('resource', p_attribute) INTO STRICT _type;
                IF _type != 'resource' THEN
                    RAISE EXCEPTION 'Cannot get allowed Resource values for Resource Attribute Type "%" because it is %-valued.  You should try using the resource_get_allowed_%_values function instead.', resource_attribute_name(p_attribute), _type, _type;
                END IF;
            
                -- if no rules exist for this combination, bail?
                FOR _auth IN SELECT * FROM
                    ruleform.resource_attribute_authorization
                    WHERE classification_attribute = p_classification_attribute
                      AND classifier = p_classifier
                      AND attribute = p_attribute
                LOOP
                    IF _auth.resource_attribute IS NOT NULL AND _auth.resource IS NOT NULL THEN
                        RETURN QUERY
                        SELECT res.*
                        FROM resource_attribute AS ratt
                        JOIN resource AS res ON ratt.resource = res.id
                        WHERE  _auth.resource_attribute = ratt.attribute
                            AND _auth.resource = ratt.resource_value;
                    END IF;
                    IF _auth.resource_attribute IS NULL AND _auth.resource IS NOT NULL THEN
                        RETURN QUERY SELECT * FROM ruleform.resource WHERE id = _auth.resource;
                    END IF;
                END LOOP;
                IF NOT FOUND THEN
                    RAISE EXCEPTION 'No authorization found for "%","%" with attribute "%"',
                        resource_attribute_name(p_classification_attribute),
                        resource_name(p_classifier),
                        resource_attribute_name(p_attribute);
                    RETURN;
                END IF;
            
                RETURN;
            END;
            $BODY$
              LANGUAGE plpgsql STABLE
              COST 100
              ROWS 1000;
            ALTER FUNCTION ruleform.resource_get_allowed_resource_values(bigint, bigint, bigint)
              OWNER TO core;
            COMMENT ON FUNCTION ruleform.resource_get_allowed_resource_values(bigint, bigint, bigint) IS 
                'For the given Resource Attribute Type and Resource (used to classify a Resource, as
                in the ruleform.get_authorized_resource_attributes(BIGINT, BIGINT) function, retrieves the
                allowed values for the given Resource Attribute Type (but only if it is a Resource-valued
                Attribute).  If no results are returned, then any Resource can be a value.  If results
                are returned, then only those Resources can be used as a value for the Attribute.  If
                the Attribute is not authorized for the given classification, an exception is thrown.';
            ]]>
        </sql>
        <rollback> DROP FUNCTION ruleform.resource_get_allowed_resource_values(bigint, bigint, bigint); </rollback>
    </changeSet>
</databaseChangeLog>
