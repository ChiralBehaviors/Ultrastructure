<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"
>
    <changeSet id="1" author="hhildebrand">
        <dropView schemaName="readable" viewName="protocol" />
        <dropColumn schemaName="ruleform" tableName="protocol" columnName="child_quantity" />
        <addColumn schemaName="ruleform" tableName="protocol">
            <column name="child_quantity" type="numeric" defaultValue="0"></column>
        </addColumn>
        <createView schemaName="readable" viewName="protocol"><![CDATA[
             SELECT base_table.id,
                base_table.name,
                s.name AS service,
                p.name AS product,
                r.name AS requester,
                dt.name AS deliver_to,
                df.name AS deliver_from,
                assign.name AS assign_to,
                base_table.quantity,
                u.name AS quantity_unit,
                ra.name AS requester_attribute,
                sa.name AS service_attribute,
                pa.name AS product_attribute,
                dta.name AS deliver_to_attribute,
                dfa.name AS deliver_from_attribute,
                ata.name AS assign_to_attribute,
                cs.name AS child_service,
                cp.name AS child_product,
                cat.name AS child_assign_to,
                base_table.child_quantity,
                cqu.name AS child_quantity_unit,
                cdt.name AS child_deliver_to,
                cdf.name AS child_deliver_from,
                csa.name AS child_service_attribute,
                cpa.name AS child_product_attribute,
                cdta.name AS child_deliver_to_attribute,
                cdfa.name AS child_deliver_from_attribute,
                cata.name AS child_assign_to_attribute,
                base_table.sequence_number,
                base_table.notes,
                up.name AS updated_by,
                base_table.update_date
               FROM ruleform.protocol base_table
               JOIN ruleform.product s ON base_table.service = s.id
               JOIN ruleform.product p ON base_table.product = p.id
               JOIN ruleform.agency r ON base_table.requester = r.id
               JOIN ruleform.location dt ON base_table.deliver_to = dt.id
               JOIN ruleform.location df ON base_table.deliver_from = df.id
               JOIN ruleform.agency assign ON base_table.assign_to = assign.id
               JOIN ruleform.unit u ON base_table.quantity_unit = u.id
               JOIN ruleform.unit cqu ON base_table.child_quantity_unit = cqu.id
               JOIN ruleform.attribute ra ON base_table.requester_attribute = ra.id
               JOIN ruleform.attribute sa ON base_table.service_attribute = sa.id
               JOIN ruleform.attribute pa ON base_table.product_attribute = pa.id
               JOIN ruleform.attribute dta ON base_table.deliver_to_attribute = dta.id
               JOIN ruleform.attribute dfa ON base_table.deliver_from_attribute = dfa.id
               JOIN ruleform.attribute ata ON base_table.assign_to_attribute = ata.id
               JOIN ruleform.product cs ON base_table.child_service = cs.id
               JOIN ruleform.product cp ON base_table.child_product = cp.id
               JOIN ruleform.agency cat ON base_table.child_assign_to = cat.id
               JOIN ruleform.location cdt ON base_table.child_deliver_to = cdt.id
               JOIN ruleform.location cdf ON base_table.child_deliver_from = cdf.id
               JOIN ruleform.attribute csa ON base_table.child_service_attribute = csa.id
               JOIN ruleform.attribute cpa ON base_table.child_product_attribute = cpa.id
               JOIN ruleform.attribute cdta ON base_table.child_deliver_to_attribute = cdta.id
               JOIN ruleform.attribute cdfa ON base_table.child_deliver_from_attribute = cdfa.id
               JOIN ruleform.attribute cata ON base_table.child_assign_to_attribute = cata.id
               JOIN ruleform.agency up ON base_table.updated_by = up.id
            ]]></createView>
        <dropUniqueConstraint schemaName="ruleform" tableName="job_chronology" constraintName="job_chronology_job_unique_constraint" />
        <addUniqueConstraint schemaName="ruleform"
            columnNames="job, sequence_number, assign_to, assign_to_attribute, deliver_from_attribute, deliver_to_attribute, product, product_attribute,
        quantity, quantity_unit, requester, requester_attribute, service, service_attribute"
            constraintName="job_chronology_job_unique_constraint" deferrable="false" disabled="false" initiallyDeferred="true" tableName="job_chronology" />
        <dropView schemaName="readable" viewName="job" />
        <dropColumn schemaName="ruleform" tableName="job" columnName="current_log_sequence" />
        <createView schemaName="readable" viewName="job"><![CDATA[
             SELECT base_table.id, 
                    s.name AS service, 
                    r.name AS requester, 
                    p.name AS product,  
                    dt.name AS deliver_to, 
                    df.name AS deliver_from, 
                    at.name AS assign_to,
                    sc.name AS status, 
                    base_table.quantity,
                    u.name AS quantity_unit,
                    base_table.parent, 
                    ra.name AS requester_attribute,
                    sa.name AS service_attribute,
                    pa.name AS product_attribute,
                    dta.name AS deliver_to_attribute,
                    dfa.name AS deliver_from_attribute,
                    ata.name AS assign_to_attribute,
                    base_table.sequence_number,
                    base_table.notes,
                    up.name AS updated_by, base_table.update_date,
                    base_table.protocol
               FROM job base_table
               JOIN product s ON base_table.service = s.id
               JOIN product p ON base_table.product = p.id
               JOIN agency at ON base_table.assign_to = at.id
               JOIN agency r ON base_table.requester = r.id
               JOIN location dt ON base_table.deliver_to = dt.id
               JOIN location df ON base_table.deliver_from = df.id
               JOIN status_code sc ON base_table.status = sc.id
               JOIN agency up ON base_table.updated_by = up.id
               JOIN attribute ra ON base_table.requester_attribute = ra.id
               JOIN attribute sa ON base_table.service_attribute = sa.id
               JOIN attribute pa ON base_table.product_attribute = pa.id
               JOIN attribute dta ON base_table.deliver_to_attribute = dta.id
               JOIN attribute dfa ON base_table.deliver_from_attribute = dfa.id
               JOIN unit u ON base_table.quantity_unit = u.id
               JOIN attribute ata ON base_table.assign_to_attribute = ata.id
            ]]></createView>
    </changeSet>
</databaseChangeLog>