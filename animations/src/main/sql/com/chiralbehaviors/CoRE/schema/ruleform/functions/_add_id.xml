<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet id="1" author="hhildebrand">
    <sql splitStatements="false"><![CDATA[
            CREATE OR REPLACE FUNCTION ruleform._add_id(value bigint, key text)
              RETURNS void AS
            $BODY$
            DECLARE
                _temp_table_name CONSTANT TEXT NOT NULL := '__shared_temp_' || key;
                _query CONSTANT TEXT NOT NULL := 'INSERT INTO ' || _temp_table_name || ' VALUES (' || value || ')';
                _create_query CONSTANT TEXT NOT NULL := 'CREATE TEMPORARY TABLE ' || _temp_table_name || ' (id BIGINT PRIMARY KEY) ON COMMIT DROP';
            BEGIN
              BEGIN
                --RAISE NOTICE 'Going to execute %', _query;
                EXECUTE _query;
              EXCEPTION
                WHEN undefined_table THEN
                    --RAISE NOTICE 'CATCH BLOCK: Going to execute %', _create_query;
                    EXECUTE _create_query;
                    --RAISE NOTICE 'CATCH BLOCK: Going to execute %', _query;
                    EXECUTE _query;
                WHEN unique_violation THEN
                    NULL;--RAISE NOTICE 'Already contains % with id %', key, value;
              END;
            END;
            $BODY$
              LANGUAGE plpgsql VOLATILE SECURITY DEFINER
              COST 100;
            COMMENT ON FUNCTION ruleform._add_id(bigint, text) IS 'Adds an ID to a temporary table, identified by the "key" parameter';
            ]]>
    </sql>
    <rollback> DROP FUNCTION ruleform._add_id(bigint, text); </rollback>
  </changeSet>
</databaseChangeLog>
