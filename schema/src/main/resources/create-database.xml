<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"
>

    <preConditions>
        <dbms type="postgresql" />
    </preConditions>

    <!-- Tag so we can roll back the change of the db creation -->
    <changeSet author="hhildebrand" id="tag_create-${db.login}-2.0.0">
        <tagDatabase tag="initial-database-create-${db.login}" />
    </changeSet>

    <changeSet id="create-${db.login}-role-2.0.0" author="hhildebrand" runInTransaction="false" context="local">
        <sql><![CDATA[
            CREATE ROLE ${db.login} WITH SUPERUSER NOINHERIT CREATEROLE LOGIN PASSWORD '${db.password}';
            ]]>
        </sql>
        <rollback>
            <sql>DROP ROLE ${db.login};</sql>
        </rollback>
    </changeSet>

    <changeSet id="create-${db.login}-role-aws-2.0.0" author="hhildebrand" runInTransaction="false" context="aws">
        <sql><![CDATA[
			CREATE ROLE ${db.login} WITH NOINHERIT CREATEROLE LOGIN PASSWORD '${db.password}';
            GRANT rds_superuser TO ${db.login} GRANTED BY ${dba.db.login};
            ]]>
        </sql>
        <rollback>
            <sql>DROP ROLE ${db.login};</sql>
        </rollback>
    </changeSet>

    <changeSet id="create-database-${db.login}-2.0.0" author="hhildebrand" runInTransaction="false">
        <sql><![CDATA[
            COMMENT ON ROLE ${db.login} IS 'Owning role of the ${db.login} Ultra-Structure database';
            ALTER ROLE ${db.login} SET search_path TO ruleform, public, readable;
            CREATE DATABASE ${db.login} ENCODING 'UTF8';
            GRANT CREATE ON DATABASE ${db.login} TO ${db.login};
            ]]>
        </sql>
        <rollback>
            <sql>DROP DATABASE IF EXISTS ${db.login}</sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
