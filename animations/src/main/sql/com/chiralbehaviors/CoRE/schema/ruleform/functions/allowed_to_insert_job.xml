<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    
    <changeSet id="1" author="hhildebrand">
        <sql splitStatements="false"><![CDATA[
            CREATE OR REPLACE FUNCTION ruleform.allowed_to_insert_job()
              RETURNS trigger AS
            $BODY$
            DECLARE
            BEGIN
                IF ( (TG_WHEN != 'BEFORE') OR (TG_OP != 'INSERT') ) THEN
                    RAISE EXCEPTION 'Trigger "%" on table "%" is improperly configured; it must only run before INSERT operations!', TG_NAME, TG_TABLE_SCHEMA || '.' || TG_TABLE_NAME;
                END IF;
            
                IF current_user = TG_ARGV[0] THEN
                    RAISE NOTICE 'Superuser is allowed to delete any rule: % % % on Rule #% of %', TG_NAME, TG_WHEN, TG_OP, NEW.id, TG_TABLE_NAME;
                    RETURN NEW;
                ELSE
                    -- Not super user
                    IF NEW.parent IS NOT NULL THEN
                        -- not a super user, trying to insert an implicit job
                        RAISE NOTICE 'Non-superusers cannot insert implicit jobs: % % % on Rule #% of %', TG_NAME, TG_WHEN, TG_OP, NEW.id, TG_TABLE_NAME;
                        RETURN NULL;
                    ELSE
                        RAISE NOTICE 'Non-superusers can insert explicit jobs: % % % on Rule #% of %', TG_NAME, TG_WHEN, TG_OP, NEW.id, TG_TABLE_NAME;
                        RETURN NEW;
                    END IF;
                END IF;
            END;
            $BODY$
              LANGUAGE plpgsql VOLATILE
              COST 100;
            ALTER FUNCTION ruleform.allowed_to_insert_job()
              OWNER TO core;
            ]]>
        </sql>
        <rollback> DROP FUNCTION ruleform.allowed_to_insert_job(); </rollback>
    </changeSet>
</databaseChangeLog>
