<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"
>

    <changeSet id="2.0.0" author="hparry">
        <createView viewName="product_location_authorization" schemaName="readable" replaceIfExists="true"><![CDATA[
            SELECT 
                w.name AS workspace,
                auth.id, 
                f_r.name as from_relationship,
                f_p.name as from_parent,
                bridge.name as connection,
                t_r.name as to_relationship,
                t_p.name as to_parent
                
                from ruleform.product_location_authorization auth
                join ruleform.agency f_r on auth.from_relationship = f_r.id
                join ruleform.relationship f_p on auth.from_parent = f_p.id
                join ruleform.relationship bridge on auth.connection = bridge.id
                join ruleform.location t_p on auth.to_parent = t_p.id
                join ruleform.relationship t_r on auth.to_relationship = t_r.id
             LEFT JOIN ruleform.workspace_authorization wa ON auth.workspace = wa.id
             LEFT JOIN ruleform.product w ON wa.defining_product = w.id
            ]]>
        </createView>
    </changeSet>
</databaseChangeLog>
