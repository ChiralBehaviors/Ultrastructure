<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="protocol and metaprotocol refactoring"
        author="hhildebrand">
        <renameColumn tableName="protocol" oldColumnName="requested_service"
            newColumnName="child_service" schemaName="ruleform" />
        <dropForeignKeyConstraint baseTableSchemaName="ruleform"
            baseTableName="protocol" constraintName="protocol_requested_service_fkey" />
        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_service" baseTableName="protocol"
            constraintName="child_service_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="product" />

        <renameColumn tableName="protocol" oldColumnName="requested_product"
            newColumnName="child_product" schemaName="ruleform" />
        <dropForeignKeyConstraint baseTableSchemaName="ruleform"
            baseTableName="protocol" constraintName="protocol_product_ordered_fkey" />
        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_product" baseTableName="protocol"
            constraintName="child_product_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="product" />

        <addColumn tableName="protocol" schemaName="ruleform">
            <column name="child_assign_to" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
            <column name="child_deliver_to" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
            <column name="child_deliver_from" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
            <column name="child_service_attribute" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
            <column name="child_product_attribute" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
            <column name="child_assign_to_attribute" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
            <column name="child_deliver_to_attribute" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
            <column name="child_deliver_from_attribute" type="CHAR(22)">
                <constraints nullable=" false " />
            </column>
        </addColumn>

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_assign_to" baseTableName="protocol"
            constraintName="child_assign_to_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="agency" />

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_deliver_to" baseTableName="protocol"
            constraintName="child_deliver_to_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="location" />

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_deliver_from" baseTableName="protocol"
            constraintName="child_deliver_from_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="location" />

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_service_attribute" baseTableName="protocol"
            constraintName="child_service_attribute_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="attribute" />

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_product_attribute" baseTableName="protocol"
            constraintName="child_product_attribute_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="attribute" />

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_assign_to_attribute" baseTableName="protocol"
            constraintName="child_assign_to_attribute_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="attribute" />

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_deliver_to_attribute" baseTableName="protocol"
            constraintName="child_deliver_to_attribute_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="attribute" />

        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="child_deliver_from_attribute"
            baseTableName="protocol" constraintName="child_deliver_from_attribute_fkey"
            deferrable="true" initiallyDeferred="true" onDelete="CASCADE"
            onUpdate="CASCADE" referencedColumnNames="id"
            referencedTableName="attribute" />

        <createView viewName="protocol" schemaName="readable"
            replaceIfExists="true"><![CDATA[
             SELECT base_table.id,
                base_table.name,
                s.name AS service,
                p.name AS product,
                r.name AS requester,
                dt.name AS deliver_to,
                df.name AS deliver_from,
                assign.name AS assign_to,
                base_table.quantity,
                u.name AS quantity_unit,
                ra.name AS requester_attribute,
                sa.name AS service_attribute,
                pa.name AS product_attribute,
                dta.name AS deliver_to_attribute,
                dfa.name AS deliver_from_attribute,
                ata.name AS assign_to_attribute,
                cs.name AS child_service,
                cp.name AS child_product,
                cat.name AS child_assign_to,
                cdt.name AS child_deliver_to,
                cdf.name AS child_deliver_from,
                csa.name AS child_service_attribute,
                cpa.name AS child_product_attribute,
                cdta.name AS child_deliver_to_attribute,
                cdfa.name AS child_deliver_from_attribute,
                cata.name AS child_assign_to_attribute,
                base_table.sequence_number,
                base_table.notes,
                up.name AS updated_by,
                base_table.update_date
               FROM ruleform.protocol base_table
               JOIN ruleform.product s ON base_table.service = s.id
               JOIN ruleform.product p ON base_table.product = p.id
               JOIN ruleform.agency r ON base_table.requester = r.id
               JOIN ruleform.location dt ON base_table.deliver_to = dt.id
               JOIN ruleform.location df ON base_table.deliver_from = df.id
               JOIN ruleform.agency assign ON base_table.assign_to = assign.id
               JOIN ruleform.unit u ON base_table.quantity_unit = u.id
               JOIN ruleform.attribute ra ON base_table.requester_attribute = ra.id
               JOIN ruleform.attribute sa ON base_table.service_attribute = sa.id
               JOIN ruleform.attribute pa ON base_table.product_attribute = pa.id
               JOIN ruleform.attribute dta ON base_table.deliver_to_attribute = dta.id
               JOIN ruleform.attribute dfa ON base_table.deliver_from_attribute = dfa.id
               JOIN ruleform.attribute ata ON base_table.assign_to_attribute = ata.id
               JOIN ruleform.product cs ON base_table.child_service = cs.id
               JOIN ruleform.product cp ON base_table.child_product = cp.id
               JOIN ruleform.agency cat ON base_table.child_assign_to = cat.id
               JOIN ruleform.location cdt ON base_table.child_deliver_to = cdt.id
               JOIN ruleform.location cdf ON base_table.child_deliver_from = cdf.id
               JOIN ruleform.attribute csa ON base_table.child_service_attribute = csa.id
               JOIN ruleform.attribute cpa ON base_table.child_product_attribute = cpa.id
               JOIN ruleform.attribute cdta ON base_table.child_deliver_to_attribute = cdta.id
               JOIN ruleform.attribute cdfa ON base_table.child_deliver_from_attribute = cdfa.id
               JOIN ruleform.attribute cata ON base_table.child_assign_to_attribute = cata.id
               JOIN ruleform.agency up ON base_table.updated_by = up.id;
        ]]>
        </createView>

        <renameColumn tableName="meta_protocol"
            oldColumnName="product_ordered" newColumnName="product"
            schemaName="ruleform" />
        <dropForeignKeyConstraint baseTableSchemaName="ruleform"
            baseTableName="meta_protocol" constraintName="meta_protocol_product_ordered_fkey" />
        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="product" baseTableName="meta_protocol"
            constraintName="meta_protocol_product_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="relationship" />

        <renameColumn tableName="meta_protocol"
            oldColumnName="product_ordered_attribute" newColumnName="product_attribute"
            schemaName="ruleform" />
        <dropForeignKeyConstraint baseTableSchemaName="ruleform"
            baseTableName="meta_protocol" constraintName="meta_protocol_product_ordered_attribute_fkey" />
        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="product_attribute" baseTableName="meta_protocol"
            constraintName="meta_protocol_product_attribute_fkey"
            deferrable="true" initiallyDeferred="true" onDelete="CASCADE"
            onUpdate="CASCADE" referencedColumnNames="id"
            referencedTableName="relationship" />

        <renameColumn tableName="meta_protocol"
            oldColumnName="requesting_agency" newColumnName="requester"
            schemaName="ruleform" />
        <dropForeignKeyConstraint baseTableSchemaName="ruleform"
            baseTableName="meta_protocol" constraintName="meta_protocol_requesting_agency_fkey" />
        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="requester" baseTableName="meta_protocol"
            constraintName="meta_requester_fkey" deferrable="true"
            initiallyDeferred="true" onDelete="CASCADE" onUpdate="CASCADE"
            referencedColumnNames="id" referencedTableName="relationship" />

        <renameColumn tableName="meta_protocol"
            oldColumnName="requesting_agency_attribute" newColumnName="requester_attribute"
            schemaName="ruleform" />
        <dropForeignKeyConstraint baseTableSchemaName="ruleform"
            baseTableName="meta_protocol"
            constraintName="meta_protocol_requesting_agency_attribute_fkey" />
        <addForeignKeyConstraint
            baseTableSchemaName="ruleform " referencedTableSchemaName="ruleform"
            baseColumnNames="requester_attribute" baseTableName="meta_protocol"
            constraintName="meta_protocol_requester_attribute_fkey"
            deferrable="true" initiallyDeferred="true" onDelete="CASCADE"
            onUpdate="CASCADE" referencedColumnNames="id"
            referencedTableName="relationship" />

        <createView viewName="meta_protocol" schemaName="readable"
            replaceIfExists="true"><![CDATA[
                 SELECT base_table.id, 
                        s.name AS service,  
                        st.name AS service_type, 
                        rr.name AS requester, 
                        po.name AS product,
                        dt.name AS deliver_to, 
                        df.name AS deliver_from, 
                        at.name AS assign_to,
                        u.name AS quantity_unit,
                        raa.name AS requester_attribute, 
                        sa.name AS service_attribute, 
                        poa.name AS product_attribute, 
                        dta.name AS deliver_to_attribute, 
                        dfa.name AS deliver_from_attribute, 
                        base_table.stop_on_match,
                        base_table.sequence_number, 
                        up.name AS updated_by, 
                        base_table.update_date
                   FROM meta_protocol base_table
                   JOIN product s ON base_table.service = s.id
                   LEFT JOIN relationship rr ON base_table.requester = rr.id
                   LEFT JOIN relationship st ON base_table.service_type = st.id
                   LEFT JOIN relationship po ON base_table.product = po.id
                   LEFT JOIN relationship dt ON base_table.deliver_to= dt.id
                   LEFT JOIN relationship df ON base_table.deliver_from = df.id 
                   LEFT JOIN relationship at ON base_table.assign_to = at.id 
                   LEFT JOIN relationship u ON base_table.quantity_unit = u.id
                   LEFT JOIN relationship raa ON base_table.requester_attribute = raa.id
                   LEFT JOIN relationship sa ON base_table.service_attribute = sa.id
                   LEFT JOIN relationship poa ON base_table.product_attribute = poa.id
                   LEFT JOIN relationship dta ON base_table.deliver_to_attribute = dta.id
                   LEFT JOIN relationship dfa ON base_table.deliver_from_attribute = dfa.id
                   
                   JOIN agency up ON base_table.updated_by = up.id;
        ]]>
        </createView>
        <createIndex schemaName="ruleform" indexName="protocol_service_idx"
            tableName="protocol" unique="false">
            <column name="service" />
        </createIndex>
        <createIndex schemaName="ruleform" indexName="protocol_product_idx"
            tableName="protocol" unique="false">
            <column name="product" />
        </createIndex>
        <createIndex schemaName="ruleform" indexName="protocol_child_service_idx"
            tableName="protocol" unique="false">
            <column name="child_service" />
        </createIndex>
        <createIndex schemaName="ruleform" indexName="protocol_child_product_idx"
            tableName="protocol" unique="false">
            <column name="child_product" />
        </createIndex>
        <createIndex schemaName="ruleform" indexName="job_service_idx"
            tableName="job" unique="false">
            <column name="service" />
        </createIndex>
        <createIndex schemaName="ruleform" indexName="job_product_idx"
            tableName="job" unique="false">
            <column name="product" />
        </createIndex>
        <createIndex schemaName="ruleform" indexName="metaprotocol_service_idx"
            tableName="meta_protocol" unique="false">
            <column name="service" />
        </createIndex>
        <createIndex schemaName="ruleform" indexName="metaprotocol_product_idx"
            tableName="meta_protocol" unique="false">
            <column name="product" />
        </createIndex>
    </changeSet>
</databaseChangeLog>
