<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1" author="hhildebrand">
        <sql><![CDATA[
            CREATE OR REPLACE VIEW readable.transformation AS 
			 SELECT t.id, s.name AS service, r.name AS agency, b.name AS product, t.sequence_number, at.name AS assign_to, rk.name AS agency_key, bk.name AS product_key, relk.name AS relationship_key, a.name AS attribute, bar.name AS product_attribute_agency
			   FROM transformation t
			   JOIN product s ON t.service = s.id
			   JOIN agency r ON t.agency = r.id
			   JOIN product b ON t.product = b.id
			   JOIN agency at ON t.assign_to = at.id
			   JOIN agency rk ON t.agency_key = rk.id
			   JOIN product bk ON t.product_key = bk.id
			   JOIN relationship relk ON t.relationship_key = relk.id
			   JOIN attribute a ON t.attribute = a.id
			   JOIN agency bar ON t.product_attribute_agency = bar.id;
			
			ALTER TABLE readable.transformation
			  OWNER TO core;
            ]]>
        </sql>
        <rollback>
            <dropView viewName="readable.transformation" />
        </rollback>
    </changeSet>
</databaseChangeLog>
