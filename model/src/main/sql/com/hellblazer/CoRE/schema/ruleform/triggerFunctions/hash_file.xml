<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    
    <changeSet id="1" author="hhildebrand">
        <sql splitStatements="false"><![CDATA[
            CREATE OR REPLACE FUNCTION ruleform.hash_file()
              RETURNS trigger AS
            $BODY$
                BEGIN
                    IF ( TG_OP = 'INSERT' ) THEN
                        IF ( NEW.file IS NOT NULL ) THEN
                            NEW.md5 := md5(NEW.file);
                        END IF;
                    END IF;
                    
                    IF ( TG_OP = 'UPDATE' ) THEN
                        IF ( NULLIF( OLD.md5, NEW.md5 ) IS NOT NULL ) THEN
                            RAISE EXCEPTION 'You cannot alter the file hash after the file has been set.';
                        END IF;
            
                        IF ( OLD.file IS NULL AND NEW.file IS NOT NULL ) THEN
                            NEW.md5 := md5(NEW.file);
                        ELSE 
                            IF ( NULLIF( OLD.file, NEW.file ) IS NOT NULL ) THEN
                                RAISE EXCEPTION 'You cannot alter file information after the file has been set.';
                            END IF;
                        END IF;
                    END IF;
                    
                    RETURN NEW;
                END;
            $BODY$
              LANGUAGE plpgsql VOLATILE
              COST 100;
            ALTER FUNCTION ruleform.hash_file()
              OWNER TO core;
            ]]>
        </sql>
        <rollback> DROP FUNCTION ruleform.hash_file(); </rollback>
    </changeSet>
</databaseChangeLog>
