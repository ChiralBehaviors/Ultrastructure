<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"
>

    <preConditions>
        <dbms type="postgresql" />
    </preConditions>

    <!-- Liquibase stores absolute file paths in their change log with the location
        of every changeset file. They figure that 200 characters is enough length
        to hold this information, and I disagree. -->

    <changeSet id="modify changelog column length" author="hparry">
        <sql><![CDATA[
            ALTER TABLE databasechangelog
            ALTER COLUMN filename TYPE varchar(4096);
            ]]>

        </sql>
    </changeSet>

    <changeSet id="create-core-role" author="hhildebrand" runInTransaction="false" context="local">
        <sql><![CDATA[
            CREATE ROLE core WITH SUPERUSER NOINHERIT CREATEROLE LOGIN PASSWORD 'password';
            ]]>
        </sql>
    </changeSet>

    <changeSet id="create-core-role-aws" author="hhildebrand" runInTransaction="false" context="aws">
        <sql><![CDATA[
			CREATE ROLE core WITH NOINHERIT CREATEROLE LOGIN PASSWORD 'password';
            GRANT rds_superuser TO core GRANTED BY ${dba.db.login};
            ]]>
        </sql>
    </changeSet>

    <changeSet id="create-database" author="hhildebrand" runInTransaction="false">
        <sql><![CDATA[
            COMMENT ON ROLE core IS 'Owning role of the CoRE Ultra-Structure database';
            ALTER ROLE core SET search_path TO ruleform, public, readable;
            CREATE DATABASE core ENCODING 'UTF8';
            GRANT CREATE ON DATABASE core TO core;
            ]]>
        </sql>
    </changeSet>

    <include relativeToChangelogFile="true" file="roles.xml" />

</databaseChangeLog>
