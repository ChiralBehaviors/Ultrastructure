<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    
    <changeSet id="1" author="hhildebrand">
        <sql splitStatements="false"><![CDATA[
            CREATE OR REPLACE FUNCTION ruleform.is_valid_as_next_status_code(p_event bigint, p_status bigint, p_status_next bigint)
              RETURNS boolean AS
            $BODY$
                SELECT EXISTS(
                    SELECT id
                    FROM ruleform.status_code_sequencing
                    WHERE service = $1
                      AND parent_code = $2
                      AND child_code = $3
                );
            $BODY$
              LANGUAGE sql STABLE
              COST 100;
            ALTER FUNCTION ruleform.is_valid_as_next_status_code(bigint, bigint, bigint)
              OWNER TO core;
            COMMENT ON FUNCTION ruleform.is_valid_as_next_status_code(bigint, bigint, bigint) IS 'Returns TRUE if the given Event and current state can lead to the given state, or FALSE otherwise.';
            ]]>
        </sql>
        <rollback> DROP FUNCTION ruleform.is_valid_as_next_status_code(bigint, bigint, bigint); </rollback>
    </changeSet>
</databaseChangeLog>
