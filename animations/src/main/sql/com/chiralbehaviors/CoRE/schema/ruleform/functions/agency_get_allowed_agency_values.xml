<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    
    <changeSet id="1" author="hhildebrand">
        <sql splitStatements="false"><![CDATA[
            CREATE OR REPLACE FUNCTION ruleform.agency_get_allowed_agency_values(p_classification_attribute bigint, p_classifier bigint, p_attribute bigint)
              RETURNS SETOF ruleform.agency AS
            $BODY$
            DECLARE
                _type TEXT;
                _auth ruleform.agency_attribute_authorization%ROWTYPE;
            BEGIN
                SELECT ruleform.get_attribute_type('agency', p_attribute) INTO STRICT _type;
                IF _type != 'agency' THEN
                    RAISE EXCEPTION 'Cannot get allowed agency values for agency Attribute Type "%" because it is %-valued.  You should try using the agency_get_allowed_%_values function instead.', agency_attribute_name(p_attribute), _type, _type;
                END IF;
            
                -- if no rules exist for this combination, bail?
                FOR _auth IN SELECT * FROM
                    ruleform.agency_attribute_authorization
                    WHERE classification_attribute = p_classification_attribute
                      AND classifier = p_classifier
                      AND attribute = p_attribute
                LOOP
                    IF _auth.agency_attribute IS NOT NULL AND _auth.agency IS NOT NULL THEN
                        RETURN QUERY
                        SELECT res.*
                        FROM agency_attribute AS ratt
                        JOIN agency AS res ON ratt.agency = res.id
                        WHERE  _auth.agency_attribute = ratt.attribute
                            AND _auth.agency = ratt.agency_value;
                    END IF;
                    IF _auth.agency_attribute IS NULL AND _auth.agency IS NOT NULL THEN
                        RETURN QUERY SELECT * FROM ruleform.agency WHERE id = _auth.agency;
                    END IF;
                END LOOP;
                IF NOT FOUND THEN
                    RAISE EXCEPTION 'No authorization found for "%","%" with attribute "%"',
                        agency_attribute_name(p_classification_attribute),
                        agency_name(p_classifier),
                        agency_attribute_name(p_attribute);
                    RETURN;
                END IF;
            
                RETURN;
            END;
            $BODY$
              LANGUAGE plpgsql STABLE
              COST 100
              ROWS 1000;
            ALTER FUNCTION ruleform.agency_get_allowed_agency_values(bigint, bigint, bigint)
              OWNER TO core;
            COMMENT ON FUNCTION ruleform.agency_get_allowed_agency_values(bigint, bigint, bigint) IS 
                'For the given agency Attribute Type and agency (used to classify a agency, as
                in the ruleform.get_authorized_agency_attributes(BIGINT, BIGINT) function, retrieves the
                allowed values for the given agency Attribute Type (but only if it is a agency-valued
                Attribute).  If no results are returned, then any agency can be a value.  If results
                are returned, then only those agencys can be used as a value for the Attribute.  If
                the Attribute is not authorized for the given classification, an exception is thrown.';
            ]]>
        </sql>
        <rollback> DROP FUNCTION ruleform.agency_get_allowed_agency_values(bigint, bigint, bigint); </rollback>
    </changeSet>
</databaseChangeLog>
