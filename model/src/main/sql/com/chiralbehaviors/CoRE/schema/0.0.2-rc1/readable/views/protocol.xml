<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"
>

    <changeSet id="1" author="hhildebrand">
        <sql><![CDATA[
            CREATE OR REPLACE VIEW readable.protocol AS 
			 SELECT base_table.id,
                    base_table.name,
                    rs.name AS requested_service,
			        r.name AS requester,  
                    rp.name AS requested_product, 
                    dt.name AS deliver_to, 
                    df.name AS deliver_from,
                    assign.name AS assign_to, 
                    s.name AS service, 
                    p.name AS product,
                    base_table.quantity,
                    u.name AS quantity_unit,
                    ra.name AS requester_attribute,
                    sa.name AS service_attribute,
                    pa.name AS product_attribute,
                    dta.name AS deliver_to_attribute,
                    dfa.name AS deliver_from_attribute,
                    ata.name AS assign_to_attribute,
			        base_table.sequence_number, 
                    base_table.notes, 
			        up.name AS updated_by,
                    base_table.version
			   FROM protocol base_table
               JOIN product rs ON base_table.requested_service = rs.id
			   JOIN product rp ON base_table.requested_product = rp.id
               JOIN product s ON base_table.service = s.id
               JOIN product p ON base_table.product = p.id
               JOIN location dt ON base_table.deliver_to = dt.id
               JOIN location df ON base_table.deliver_from = df.id
			   JOIN agency assign ON base_table.assign_to = assign.id
               JOIN agency r ON base_table.requester = r.id
			   JOIN agency up ON base_table.updated_by = up.id
               JOIN unit u ON base_table.quantity_unit = u.id
               JOIN attribute ra ON base_table.requester_attribute = ra.id
               JOIN attribute sa ON base_table.service_attribute = sa.id
               JOIN attribute pa ON base_table.product_attribute = pa.id
               JOIN attribute dta ON base_table.deliver_to_attribute = dta.id
               JOIN attribute dfa ON base_table.deliver_from_attribute = dfa.id
               JOIN attribute ata ON base_table.assign_to_attribute = ata.id;
			
			ALTER TABLE readable.protocol
			  OWNER TO core;
			GRANT ALL ON TABLE readable.protocol TO core;
			GRANT SELECT ON TABLE readable.protocol TO core_read_write;
			GRANT SELECT ON TABLE readable.protocol TO core_read_only;
            ]]>
        </sql>
        <rollback>
            <dropView viewName="readable.protocol" />
        </rollback>
    </changeSet>
</databaseChangeLog>
